package vulnerability

import "time"

// Vulnerability represents a single security vulnerability found in an image
type Vulnerability struct {
	ID                int       `json:"id"`
	ImageID           string    `json:"image_id"`
	VulnerabilityID   string    `json:"vulnerability_id"` // CVE-2024-1234
	PkgName           string    `json:"pkg_name"`
	InstalledVersion  string    `json:"installed_version"`
	FixedVersion      string    `json:"fixed_version"`
	Severity          string    `json:"severity"` // CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
	Title             string    `json:"title"`
	Description       string    `json:"description"`
	PublishedDate     time.Time `json:"published_date"`
	LastModifiedDate  time.Time `json:"last_modified_date"`
	PrimaryURL        string    `json:"primary_url"`
}

// SeverityCounts holds counts of vulnerabilities by severity
type SeverityCounts struct {
	Critical int `json:"critical"`
	High     int `json:"high"`
	Medium   int `json:"medium"`
	Low      int `json:"low"`
	Unknown  int `json:"unknown"`
}

// VulnerabilityScan represents metadata about a vulnerability scan
type VulnerabilityScan struct {
	ID                   int            `json:"id"`
	ImageID              string         `json:"image_id"`
	ImageName            string         `json:"image_name"`
	ScannedAt            time.Time      `json:"scanned_at"`
	ScanDurationMs       int64          `json:"scan_duration_ms"`
	Success              bool           `json:"success"`
	Error                string         `json:"error,omitempty"`
	TrivyDBVersion       string         `json:"trivy_db_version"`
	TotalVulnerabilities int            `json:"total_vulnerabilities"`
	SeverityCounts       SeverityCounts `json:"severity_counts"`
}

// VulnerabilityScanResult is the complete result of scanning an image
type VulnerabilityScanResult struct {
	Scan            VulnerabilityScan `json:"scan"`
	Vulnerabilities []Vulnerability   `json:"vulnerabilities"`
}

// ScanSummary provides an overview of all vulnerability scans
type ScanSummary struct {
	TotalImagesScanned       int            `json:"total_images_scanned"`
	ImagesWithVulnerabilities int            `json:"images_with_vulnerabilities"`
	TotalVulnerabilities     int            `json:"total_vulnerabilities"`
	SeverityCounts           SeverityCounts `json:"severity_counts"`
	LastScan                 time.Time      `json:"last_scan"`
	TrivyDBVersion           string         `json:"trivy_db_version"`
}

// ScanJob represents a queued scan job
type ScanJob struct {
	ImageID   string
	ImageName string
	Priority  int       // Higher = more important
	QueuedAt  time.Time
}

// ScanQueueStatus provides information about the scan queue
type ScanQueueStatus struct {
	Queued        int       `json:"queued"`
	InProgress    int       `json:"in_progress"`
	CompletedToday int      `json:"completed_today"`
	FailedToday   int       `json:"failed_today"`
	QueueItems    []ScanJob `json:"queue_items"`
	TotalWorkers  int       `json:"total_workers"`
	ActiveWorkers int       `json:"active_workers"`
}

// TrivyResult represents the JSON output from Trivy CLI
type TrivyResult struct {
	SchemaVersion int `json:"SchemaVersion"`
	ArtifactName  string `json:"ArtifactName"`
	ArtifactType  string `json:"ArtifactType"`
	Metadata      struct {
		ImageID     string `json:"ImageID"`
		DiffIDs     []string `json:"DiffIDs"`
		RepoTags    []string `json:"RepoTags"`
		RepoDigests []string `json:"RepoDigests"`
	} `json:"Metadata"`
	Results []struct {
		Target          string `json:"Target"`
		Class           string `json:"Class"`
		Type            string `json:"Type"`
		Vulnerabilities []struct {
			VulnerabilityID  string    `json:"VulnerabilityID"`
			PkgName          string    `json:"PkgName"`
			InstalledVersion string    `json:"InstalledVersion"`
			FixedVersion     string    `json:"FixedVersion"`
			Severity         string    `json:"Severity"`
			Title            string    `json:"Title"`
			Description      string    `json:"Description"`
			PublishedDate    time.Time `json:"PublishedDate"`
			LastModifiedDate time.Time `json:"LastModifiedDate"`
			PrimaryURL       string    `json:"PrimaryURL"`
		} `json:"Vulnerabilities"`
	} `json:"Results"`
}

// CalculateSeverityCounts calculates severity counts from a list of vulnerabilities
func CalculateSeverityCounts(vulns []Vulnerability) SeverityCounts {
	counts := SeverityCounts{}
	for _, v := range vulns {
		switch v.Severity {
		case "CRITICAL":
			counts.Critical++
		case "HIGH":
			counts.High++
		case "MEDIUM":
			counts.Medium++
		case "LOW":
			counts.Low++
		default:
			counts.Unknown++
		}
	}
	return counts
}

// GetTotal returns the total number of vulnerabilities across all severities
func (sc SeverityCounts) GetTotal() int {
	return sc.Critical + sc.High + sc.Medium + sc.Low + sc.Unknown
}
